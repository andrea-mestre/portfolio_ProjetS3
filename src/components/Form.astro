---
import PurpleBackgroundSvg from '../assets/svg/purple_background.svg?raw';
---

<div class="relative w-full h-auto flex flex-col">
	<div class="form-background" set:html={PurpleBackgroundSvg}></div>
	<div class="relative z-10 flex items-center justify-center min-h-[600px] p-8">
		<form id="contact-form" class="flex flex-col gap-7 w-full max-w-5xl px-12 -ml-20">
			<div class="grid grid-cols-2 gap-12">
				<div class="flex flex-col gap-2">
					<label class="form-label text-white text-lg uppercase tracking-wider font-normal">PRÉNOM</label>
					<input type="text" name="prenom" required class="form-input bg-white border-none rounded-lg px-12 py-3 text-gray-800 text-sm transition-all duration-300 focus:outline-none focus:bg-white focus:shadow-[0_0_0_2px_rgba(150,46,185,0.5)]">
				</div>
				<div class="flex flex-col gap-2">
					<label class="form-label text-white text-lg uppercase tracking-wider font-normal">NOM</label>
					<input type="text" name="nom" required class="form-input bg-white border-none rounded-lg px-12 py-3 text-gray-800 text-sm transition-all duration-300 focus:outline-none focus:bg-white focus:shadow-[0_0_0_2px_rgba(150,46,185,0.5)]">
				</div>
			</div>
			
			<div class="flex flex-col gap-2">
				<label class="form-label text-white text-lg uppercase tracking-wider font-normal">E-MAIL</label>
				<input type="email" name="mail" required class="form-input bg-white border-none rounded-lg px-12 py-3 text-gray-800 text-sm transition-all duration-300 focus:outline-none focus:bg-white focus:shadow-[0_0_0_2px_rgba(150,46,185,0.5)]">
			</div>
			
			<div class="flex flex-col gap-2">
				<label class="form-label text-white text-lg uppercase tracking-wider font-normal">SUJET</label>
				<input type="text" name="sujet" required class="form-input bg-white border-none rounded-lg px-12 py-3 text-gray-800 text-sm transition-all duration-300 focus:outline-none focus:bg-white focus:shadow-[0_0_0_2px_rgba(150,46,185,0.5)]">
			</div>
			
			<div class="flex flex-col gap-2">
				<label class="form-label text-white text-lg uppercase tracking-wider font-normal">MESSAGE</label>
				<textarea name="message" rows="4" required class="form-textarea bg-white border-none rounded-lg px-12 py-4 text-gray-800 text-sm transition-all duration-300 min-h-32 resize-none focus:outline-none focus:bg-white focus:shadow-[0_0_0_2px_rgba(150,46,185,0.5)]"></textarea>
			</div>
			
			<div class="flex justify-center mt-4">
				<button type="submit" id="submit-btn" class="form-submit relative bg-transparent border border-white/80 text-white px-8 py-3 text-sm uppercase tracking-[0.2em] cursor-pointer flex items-center gap-3 transition-all duration-300 overflow-hidden hover:border-[#B8BBF0] hover:shadow-[0_0_20px_rgba(184,187,240,0.4)] hover:-translate-y-0.5 rounded-lg">
					<span class="arrow-left"></span>
					<span id="button-text">ENVOYER</span>
					<span class="arrow-right"></span>
				</button>
			</div>
			
			<!-- Message de statut -->
			<div id="form-status" class="text-center mt-4 opacity-0 transition-all duration-300">
				<p id="status-message" class="text-sm"></p>
			</div>
		</form>
	</div>
</div>

<style>

	.form-background {
		position: absolute;
		top: 0;
		right: 0px;
		bottom: 0;
		width: 850px;
		height: 100%;
		z-index: 1;
		pointer-events: none;
		overflow: hidden;
	}

	.form-background svg {
		width: 100%;
		height: 100%;
		object-fit: cover;
		position: absolute;
		top: 0;
		left: 0;
		display: block;
	}

	/* Font family for form elements */
	.form-label, .form-input, .form-textarea, .form-submit {
		font-family: var(--font-title2), 'Nebula_Regular', sans-serif;
	}

	/* Léger effet de néon sur les champs */
	.form-input, .form-textarea {
		box-shadow: 0 0 15px rgba(184, 187, 240, 0.3), 0 0 25px rgba(150, 46, 185, 0.15);
		transition: all 0.3s ease;
	}

	.form-input:focus, .form-textarea:focus {
		box-shadow: 0 0 20px rgba(184, 187, 240, 0.5), 0 0 35px rgba(150, 46, 185, 0.3), 0 0 50px rgba(184, 187, 240, 0.2);
	}

	/* Léger effet de néon sur les labels */
	.form-label {
		text-shadow: 0 0 10px rgba(255, 255, 255, 0.2), 0 0 20px rgba(184, 187, 240, 0.1);
	}

	/* Léger effet de néon sur le bouton */
	.form-submit {
		box-shadow: 0 0 15px rgba(184, 187, 240, 0.2), 0 0 25px rgba(150, 46, 185, 0.1);
	}

	.form-submit:hover {
		box-shadow: 0 0 25px rgba(184, 187, 240, 0.4), 0 0 40px rgba(150, 46, 185, 0.3), 0 0 60px rgba(184, 187, 240, 0.2);
	}

	/* Button effects */
	.form-submit::before {
		content: '';
		position: absolute;
		top: 0;
		left: -100%;
		width: 100%;
		height: 100%;
		background: linear-gradient(90deg, transparent, rgba(184,187,240,0.3), transparent);
		transition: left 0.5s ease;
	}

	.form-submit:hover::before {
		left: 100%;
	}

	.arrow-left, .arrow-right {
		font-size: 12px;
		transition: transform 0.3s ease;
	}

	.form-submit:hover .arrow-left {
		transform: translateX(-2px);
	}

	.form-submit:hover .arrow-right {
		transform: translateX(2px);
	}

	/* Styles pour les messages de statut */
	.status-success {
		color: var(--color-purple);
		text-shadow: 0 0 10px rgba(184, 187, 240, 0.6);
	}

	.status-error {
		color: #ff6b6b;
		text-shadow: 0 0 10px rgba(255, 107, 107, 0.6);
	}

	.status-loading {
		color: var(--color-pink);
		text-shadow: 0 0 10px rgba(150, 46, 185, 0.6);
	}
</style>

<script>
	import { createContact, POCKETBASE_URL } from '../lib/pocketbase.ts';

	document.addEventListener('DOMContentLoaded', () => {
		const form = document.getElementById('contact-form') as HTMLFormElement;
		const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
		const buttonText = document.getElementById('button-text') as HTMLSpanElement;
		const formStatus = document.getElementById('form-status') as HTMLDivElement;
		const statusMessage = document.getElementById('status-message') as HTMLParagraphElement;

		if (!form || !submitBtn || !buttonText || !formStatus || !statusMessage) {
			console.error('Éléments du formulaire introuvables');
			return;
		}

		console.log('URL PocketBase utilisée:', POCKETBASE_URL);

		// Fonction pour afficher un message de statut
		function showStatus(message: string, type: 'success' | 'error' | 'loading') {
			statusMessage.textContent = message;
			statusMessage.className = `text-sm status-${type}`;
			formStatus.style.opacity = '1';
			
			if (type !== 'loading') {
				setTimeout(() => {
					formStatus.style.opacity = '0';
				}, 5000);
			}
		}

		// Fonction pour réinitialiser le bouton
		function resetButton() {
			submitBtn.disabled = false;
			buttonText.textContent = 'ENVOYER';
			submitBtn.style.opacity = '1';
		}

		// Fonction pour définir l'état de chargement du bouton
		function setLoadingState() {
			submitBtn.disabled = true;
			buttonText.textContent = 'ENVOI...';
			submitBtn.style.opacity = '0.7';
		}

		// Gestionnaire de soumission du formulaire
		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			
			// Récupérer les données du formulaire
			const formData = new FormData(form);
			const contactData = {
				prenom: formData.get('prenom') as string,
				nom: formData.get('nom') as string,
				mail: formData.get('mail') as string,
				sujet: formData.get('sujet') as string,
				message: formData.get('message') as string,
			};

			// Validation simple côté client
			if (!contactData.prenom || !contactData.nom || !contactData.mail || !contactData.sujet || !contactData.message) {
				showStatus('Veuillez remplir tous les champs', 'error');
				return;
			}

			// Validation de l'email
			const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
			if (!emailRegex.test(contactData.mail)) {
				showStatus('Veuillez entrer une adresse email valide', 'error');
				return;
			}

			try {
				setLoadingState();
				showStatus('Envoi en cours...', 'loading');

				console.log('Données à envoyer:', contactData);

				// Envoyer à PocketBase
				const result = await createContact(contactData);
				
				console.log('Résultat de l\'envoi:', result);
				
				if (result) {
					showStatus('Message envoyé avec succès ! Merci de m\'avoir contacté.', 'success');
					form.reset(); // Réinitialiser le formulaire
				} else {
					throw new Error('Échec de l\'envoi');
				}
			} catch (error) {
				console.error('Erreur détaillée lors de l\'envoi:', error);
				
				// Afficher des messages d'erreur plus spécifiques
				let errorMessage = 'Erreur lors de l\'envoi. Veuillez réessayer plus tard.';
				
				if (error instanceof Error) {
					if (error.message.includes('fetch')) {
						errorMessage = 'Impossible de se connecter au serveur. Vérifiez que PocketBase est démarré.';
					} else if (error.message.includes('ECONNREFUSED')) {
						errorMessage = 'Serveur PocketBase non accessible. Veuillez redémarrer PocketBase.';
					} else if (error.message.includes('400')) {
						errorMessage = 'Données du formulaire invalides. Vérifiez vos informations.';
					} else if (error.message.includes('500')) {
						errorMessage = 'Erreur du serveur. Réessayez dans quelques instants.';
					}
				}
				
				showStatus(errorMessage, 'error');
			} finally {
				resetButton();
			}
		});
	});
</script>