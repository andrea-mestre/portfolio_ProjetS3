---
interface Props {
	projects: Array<{
		categories?: string[];
		etude_annee: string;
		projet_annee: string;
	}>;
}

const { projects } = Astro.props;

// Extraction des données uniques pour les filtres
const categories = new Set<string>();
const studyYears = new Set<string>();
const projectYears = new Set<string>();

projects.forEach(project => {
	// Catégories
	if (project.categories) {
		project.categories.forEach(cat => cat && categories.add(cat));
	}
	
	// Années d'étude
	if (project.etude_annee) {
		studyYears.add(project.etude_annee);
	}
	
	// Années de projet
	if (project.projet_annee) {
		const year = new Date(project.projet_annee).getFullYear().toString();
		projectYears.add(year);
	}
});

const sortedCategories = Array.from(categories).sort();
const sortedStudyYears = Array.from(studyYears).sort();
const sortedProjectYears = Array.from(projectYears).sort().reverse();
---

<section class="filters-section flex justify-center py-8 px-8 opacity-0">
	<div class="filters-container max-w-7xl w-full relative">
		<!-- Coins décoratifs HUD -->
		<div class="hud-corner hud-corner-tl"></div>
		<div class="hud-corner hud-corner-tr"></div>
		<div class="hud-corner hud-corner-bl"></div>
		<div class="hud-corner hud-corner-br"></div>
		
		<div class="filters-wrapper border border-[--color-purple]/50 rounded-lg p-8 backdrop-blur-md bg-gradient-to-br from-black/40 via-black/30 to-black/40 relative overflow-hidden">
			<!-- Effet de grille de fond -->
			<div class="filters-grid-bg"></div>
			
			<!-- Ligne de scan animée -->
			<div class="scan-line"></div>
			
			<!-- Titre des filtres -->
			<div class="filters-header flex items-center justify-between mb-8 relative z-10">
				<div class="flex items-center gap-4">
					<div class="filter-icon-wrapper">
						<svg class="w-6 h-6 text-[--color-purple] filter-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
						</svg>
					</div>
					<h3 class="font-[family-name:var(--font-title2)] text-2xl tracking-[0.2em] text-[--color-purple] filter-title">SYSTÈME DE FILTRAGE</h3>
				</div>
				<div class="status-indicator"></div>
			</div>

			<!-- Grille de filtres -->
			<div class="filters-grid grid grid-cols-1 md:grid-cols-3 gap-6 relative z-10">
				<!-- Filtre par catégorie -->
				<div class="filter-group">
					<label class="filter-label font-[family-name:var(--font-text)] text-xs text-[--color-purple] uppercase tracking-[0.2em] mb-3 block flex items-center gap-2">
						<span class="label-indicator"></span>
						CATÉGORIE
					</label>
					<div class="select-wrapper">
						<select 
							id="filter-category" 
							class="filter-select w-full bg-black/60 border border-[--color-purple]/50 rounded px-4 py-3 text-white font-[family-name:var(--font-text)] text-sm focus:outline-none focus:border-[--color-pink] transition-all cursor-pointer"
						>
							<option value="">// Toutes les catégories</option>
							{sortedCategories.map(category => (
								<option value={category}>{category}</option>
							))}
						</select>
					</div>
				</div>

				<!-- Filtre par année d'étude -->
				<div class="filter-group">
					<label class="filter-label font-[family-name:var(--font-text)] text-xs text-[--color-purple] uppercase tracking-[0.2em] mb-3 block flex items-center gap-2">
						<span class="label-indicator"></span>
						ANNÉE D'ÉTUDE
					</label>
					<div class="select-wrapper">
						<select 
							id="filter-study-year" 
							class="filter-select w-full bg-black/60 border border-[--color-purple]/50 rounded px-4 py-3 text-white font-[family-name:var(--font-text)] text-sm focus:outline-none focus:border-[--color-pink] transition-all cursor-pointer"
						>
							<option value="">// Toutes les années</option>
							{sortedStudyYears.map(year => (
								<option value={year}>{year}</option>
							))}
						</select>
					</div>
				</div>

				<!-- Filtre par année de projet -->
				<div class="filter-group">
					<label class="filter-label font-[family-name:var(--font-text)] text-xs text-[--color-purple] uppercase tracking-[0.2em] mb-3 block flex items-center gap-2">
						<span class="label-indicator"></span>
						ANNÉE DE PROJET
					</label>
					<div class="select-wrapper">
						<select 
							id="filter-project-year" 
							class="filter-select w-full bg-black/60 border border-[--color-purple]/50 rounded px-4 py-3 text-white font-[family-name:var(--font-text)] text-sm focus:outline-none focus:border-[--color-pink] transition-all cursor-pointer"
						>
							<option value="">// Toutes les années</option>
							{sortedProjectYears.map(year => (
								<option value={year}>{year}</option>
							))}
						</select>
					</div>
				</div>
			</div>

			<!-- Séparateur -->
			<div class="filter-separator my-6"></div>
			
			<!-- Bouton reset -->
			<div class="filters-actions flex justify-end items-center relative z-10">
				<button 
					id="reset-filters"
					class="reset-button group relative px-6 py-3 border-2 border-[--color-purple]/50 rounded font-[family-name:var(--font-text)] text-xs text-[--color-purple] hover:text-white hover:border-[--color-pink] transition-all duration-300 flex items-center gap-3 tracking-[0.15em] uppercase overflow-hidden"
				>
					<div class="reset-button-bg"></div>
					<svg class="w-4 h-4 relative z-10 group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
					</svg>
					<span class="relative z-10">Réinitialiser</span>
				</button>
			</div>
		</div>
	</div>
</section>

<style>
	/* Section Filtres */
	.filters-section {
		animation: filtersFadeIn 1s ease-out 2.5s forwards;
	}

	@keyframes filtersFadeIn {
		0% {
			opacity: 0;
			transform: translateY(20px);
		}
		100% {
			opacity: 1;
			transform: translateY(0);
		}
	}

	/* Coins HUD décoratifs */
	.hud-corner {
		position: absolute;
		width: 30px;
		height: 30px;
		z-index: 20;
	}

	.hud-corner::before,
	.hud-corner::after {
		content: '';
		position: absolute;
		background: var(--color-purple);
		box-shadow: 0 0 10px var(--color-purple);
	}

	.hud-corner::before {
		width: 100%;
		height: 2px;
	}

	.hud-corner::after {
		width: 2px;
		height: 100%;
	}

	.hud-corner-tl {
		top: -2px;
		left: -2px;
	}

	.hud-corner-tl::before {
		top: 0;
		left: 0;
	}

	.hud-corner-tl::after {
		top: 0;
		left: 0;
	}

	.hud-corner-tr {
		top: -2px;
		right: -2px;
	}

	.hud-corner-tr::before {
		top: 0;
		right: 0;
	}

	.hud-corner-tr::after {
		top: 0;
		right: 0;
	}

	.hud-corner-bl {
		bottom: -2px;
		left: -2px;
	}

	.hud-corner-bl::before {
		bottom: 0;
		left: 0;
	}

	.hud-corner-bl::after {
		bottom: 0;
		left: 0;
	}

	.hud-corner-br {
		bottom: -2px;
		right: -2px;
	}

	.hud-corner-br::before {
		bottom: 0;
		right: 0;
	}

	.hud-corner-br::after {
		bottom: 0;
		right: 0;
	}

	.filters-wrapper {
		box-shadow: 
			0 0 30px rgba(184, 187, 240, 0.2),
			inset 0 0 40px rgba(0, 0, 0, 0.6);
		position: relative;
	}

	/* Grille de fond animée */
	.filters-grid-bg {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-image: 
			linear-gradient(rgba(184, 187, 240, 0.03) 1px, transparent 1px),
			linear-gradient(90deg, rgba(184, 187, 240, 0.03) 1px, transparent 1px);
		background-size: 20px 20px;
		opacity: 0.5;
		z-index: 0;
	}

	/* Ligne de scan animée - DÉSACTIVÉE */
	.scan-line {
		display: none;
	}

	/* Header des filtres */
	.filters-header {
		text-shadow: 0 0 15px rgba(184, 187, 240, 0.5);
	}

	.filter-icon-wrapper {
		position: relative;
		padding: 8px;
		border: 1px solid var(--color-purple);
		border-radius: 4px;
		background: rgba(0, 0, 0, 0.4);
		box-shadow: 0 0 15px rgba(184, 187, 240, 0.3);
	}

	.filter-icon {
		animation: iconPulse 2s ease-in-out infinite;
		color: var(--color-purple) !important;
		stroke: var(--color-purple) !important;
	}

	@keyframes iconPulse {
		0%, 100% {
			filter: drop-shadow(0 0 5px var(--color-purple));
		}
		50% {
			filter: drop-shadow(0 0 10px var(--color-pink));
		}
	}

	.filter-title {
		text-shadow: 0 0 15px var(--color-purple);
		color: var(--color-white) !important;
	}

	/* Indicateur de statut */
	.status-indicator {
		width: 12px;
		height: 12px;
		border-radius: 50%;
		background: var(--color-purple);
		box-shadow: 
			0 0 5px var(--color-purple),
			0 0 10px var(--color-purple),
			inset 0 0 5px rgba(255, 255, 255, 0.5);
		animation: statusBlink 2s ease-in-out infinite;
	}

	@keyframes statusBlink {
		0%, 100% {
			opacity: 1;
			box-shadow: 
				0 0 5px var(--color-purple),
				0 0 10px var(--color-purple);
		}
		50% {
			opacity: 0.5;
			box-shadow: 
				0 0 2px var(--color-purple),
				0 0 5px var(--color-purple);
		}
	}

	/* Labels des filtres */
	.filter-label {
		text-shadow: 0 0 10px rgba(184, 187, 240, 0.5);
		animation: labelGlow 3s ease-in-out infinite;
		color: var(--color-white) !important;
	}

	@keyframes labelGlow {
		0%, 100% {
			text-shadow: 0 0 5px rgba(184, 187, 240, 0.5);
		}
		50% {
			text-shadow: 0 0 10px rgba(184, 187, 240, 0.8);
		}
	}

	.label-indicator {
		width: 6px;
		height: 6px;
		border-radius: 50%;
		background: var(--color-purple);
		box-shadow: 0 0 5px var(--color-purple);
		animation: indicatorPulse 1.5s ease-in-out infinite;
	}

	@keyframes indicatorPulse {
		0%, 100% {
			transform: scale(1);
			opacity: 1;
		}
		50% {
			transform: scale(1.3);
			opacity: 0.7;
		}
	}

	/* Selects stylisés */
	.select-wrapper {
		position: relative;
	}

	.select-wrapper::before {
		content: '';
		position: absolute;
		top: -2px;
		left: -2px;
		right: -2px;
		bottom: -2px;
		background: linear-gradient(45deg, 
			var(--color-purple), 
			var(--color-pink), 
			var(--color-purple));
		border-radius: 4px;
		opacity: 0;
		transition: opacity 0.3s ease;
		z-index: -1;
	}

	.select-wrapper:hover::before {
		opacity: 0.3;
	}

	.filter-select {
		appearance: none;
		background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%23B8BBF0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
		background-position: right 0.75rem center;
		background-repeat: no-repeat;
		background-size: 1.5em 1.5em;
		padding-right: 3rem;
		box-shadow: 
			inset 0 0 20px rgba(0, 0, 0, 0.5),
			0 0 0 rgba(184, 187, 240, 0);
		transition: all 0.3s ease;
	}

	.filter-select:hover {
		border-color: var(--color-purple);
		box-shadow: 
			inset 0 0 20px rgba(0, 0, 0, 0.5),
			0 0 15px rgba(184, 187, 240, 0.4);
		transform: translateY(-2px);
	}

	.filter-select:focus {
		border-color: var(--color-pink);
		box-shadow: 
			inset 0 0 20px rgba(0, 0, 0, 0.5),
			0 0 20px rgba(150, 46, 185, 0.5);
	}

	.filter-select option {
		background-color: #0a0a0a;
		color: white;
		padding: 10px;
	}

	/* Séparateur */
	.filter-separator {
		height: 1px;
		background: linear-gradient(90deg, 
			transparent, 
			var(--color-purple), 
			var(--color-pink), 
			var(--color-purple), 
			transparent);
		box-shadow: 0 0 10px rgba(184, 187, 240, 0.5);
	}

	/* Bouton reset stylisé */
	.reset-button {
		position: relative;
		box-shadow: 
			0 0 10px rgba(184, 187, 240, 0.2),
			inset 0 0 10px rgba(0, 0, 0, 0.5);
		color: var(--color-white) !important;
	}

	.reset-button svg {
		stroke: var(--color-white) !important;
	}

	.reset-button-bg {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: linear-gradient(45deg, 
			var(--color-purple), 
			var(--color-pink));
		opacity: 0;
		transition: opacity 0.3s ease;
	}

	.reset-button:hover .reset-button-bg {
		opacity: 0.2;
	}

	.reset-button:hover {
		box-shadow: 
			0 0 20px rgba(184, 187, 240, 0.5),
			inset 0 0 10px rgba(184, 187, 240, 0.1);
		transform: translateY(-2px);
		color: var(--color-pink) !important;
	}

	.reset-button:hover svg {
		stroke: var(--color-pink) !important;
	}

	.reset-button:active {
		transform: translateY(0);
	}

	/* Responsive adjustments */
	@media (max-width: 768px) {
		.filters-grid {
			grid-template-columns: 1fr;
		}
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		initializeFilters();
	});

	function initializeFilters() {
		const projectCards = document.querySelectorAll('.project-card-link');
		const categoryFilter = document.getElementById('filter-category') as HTMLSelectElement;
		const studyYearFilter = document.getElementById('filter-study-year') as HTMLSelectElement;
		const projectYearFilter = document.getElementById('filter-project-year') as HTMLSelectElement;
		const resetButton = document.getElementById('reset-filters');

		if (!categoryFilter || !studyYearFilter || !projectYearFilter) {
			return;
		}

		// Stocker les données de chaque carte pour le filtrage
		const projectsData: Array<{
			element: Element;
			categories: string[];
			studyYear: string;
			projectYear: string;
		}> = [];

		projectCards.forEach((card) => {
			const categoriesAttr = card.getAttribute('data-categories') || '';
			const studyYearAttr = card.getAttribute('data-study-year') || '';
			const projectYearAttr = card.getAttribute('data-project-year') || '';

			const projectCategories = categoriesAttr ? categoriesAttr.split(',').map(c => c.trim()) : [];

			projectsData.push({
				element: card,
				categories: projectCategories,
				studyYear: studyYearAttr.trim(),
				projectYear: projectYearAttr.trim()
			});
		});

		// Fonction de filtrage
		function applyFilters() {
			const selectedCategory = categoryFilter.value;
			const selectedStudyYear = studyYearFilter.value;
			const selectedProjectYear = projectYearFilter.value;

			projectsData.forEach(project => {
				let isVisible = true;

				// Filtre par catégorie
				if (selectedCategory && !project.categories.includes(selectedCategory)) {
					isVisible = false;
				}

				// Filtre par année d'étude
				if (selectedStudyYear && project.studyYear !== selectedStudyYear) {
					isVisible = false;
				}

				// Filtre par année de projet
				if (selectedProjectYear && project.projectYear !== selectedProjectYear) {
					isVisible = false;
				}

				// Appliquer la visibilité
				if (isVisible) {
					project.element.classList.remove('hidden-by-filter');
				} else {
					project.element.classList.add('hidden-by-filter');
				}
			});
		}

		// Event listeners
		categoryFilter.addEventListener('change', applyFilters);
		studyYearFilter.addEventListener('change', applyFilters);
		projectYearFilter.addEventListener('change', applyFilters);

		resetButton?.addEventListener('click', () => {
			categoryFilter.value = '';
			studyYearFilter.value = '';
			projectYearFilter.value = '';
			applyFilters();
		});
	}
</script>
