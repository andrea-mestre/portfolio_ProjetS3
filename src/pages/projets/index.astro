---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import HudHeader from "../../components/HudHeader.astro";
import CardProject from "../../components/CardProject.astro";
import ProjectStatus from "../../components/ProjectStatus.astro";
import FilterSystem from "../../components/FilterSystem.astro";
import {
	getProjects,
	calculateProjectStats,
	formatProjectDate,
	generateProjectId,
	getProjectImageUrl,
	type Project,
} from "../../lib/pocketbase";

let projects: Project[] = [];
let hasError = false;

try {
	projects = await getProjects();
	console.log("Projets récupérés:", projects.length);
} catch (error) {
	console.error("Erreur lors de la récupération des projets:", error);
	hasError = true;
}

function generateProjectSlug(project: any): string {
	return project.titre
		.toLowerCase()
		.replace(/\s+/g, "-")
		.replace(/[^a-z0-9-]/g, "");
}
---

<Layout>
	<HudHeader currentPage="projets" />
	<main class="relative z-10 pt-24">
		<div class="flex justify-center mb-0">
			<h1
				class="text-white tracking-wide whitespace-nowrap drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]"
				style="font-family: var(--font-title1); font-size: var(--size-title1);"
			>
				MES PROJETS
			</h1>
		</div>

		<section class="hero-projects flex justify-center py-0 px-8 pt-0">
			<div class="text-center max-w-4xl">
				<h2
					class="projects-hero-title font-[family-name:var(--font-title2)] font-bold mb-6 tracking-[0.15em] text-center section-neon mt-0"
					style="color: var(--color-darkpurple); font-size: var(--size-h2);"
				>
					MES PROJETS
				</h2>

				<p
					class="projects-hero-description font-[family-name:var(--font-text)] --size-text --size-text text-white/70 leading-relaxed mb-8 opacity-0"
				>
					Découvrez une sélection de mes réalisations en design
					graphique, développement web et communication visuelle.
				</p>

				<div
					class="projects-stats flex justify-center gap-8 md:gap-12 mt-8 mb-4 opacity-0"
				>
					<div class="stat-item text-center">
						<div
							class="stat-number font-[family-name:var(--font-title2)] text-4xl font-bold tracking-[0.15em] section-neon mb-2"
							style="color: var(--color-darkpurple);"
						>
							{projects.length}
						</div>
						<div
							class="stat-label font-[family-name:var(--font-text)] text-xs md:text-sm text-white/60 uppercase tracking-wide"
						>
							Projets
						</div>
					</div>
					<div class="stat-item text-center">
						<div
							class="stat-number font-[family-name:var(--font-title2)] text-4xl font-bold tracking-[0.15em] section-neon mb-2"
							style="color: var(--color-darkpurple);"
						>
							2025
						</div>
						<div
							class="stat-label font-[family-name:var(--font-text)] text-xs md:text-sm text-white/60 uppercase tracking-wide"
						>
							Année
						</div>
					</div>
				</div>
			</div>
		</section>

		<FilterSystem projects={projects} />

		<section
			class="projects-grid-section flex items-center justify-center py-10 px-8"
		>
			<div class="container max-w-7xl mx-auto">
				{
					hasError ? (
						<ProjectStatus
							type="error"
							message="Impossible de se connecter à la base de données. Vérifiez que PocketBase est en cours d'exécution sur le port 8090."
						/>
					) : projects.length > 0 ? (
						<div class="projects-grid flex flex-wrap justify-center gap-8 lg:gap-12">
							{projects.map((project) => {
								const projectYear = new Date(
									project.projet_annee,
								)
									.getFullYear()
									.toString();
								return (
									<a
										href={`/projets/${generateProjectSlug(project)}`}
										class="project-card-link"
										data-categories={(
											project.categories || []
										).join(",")}
										data-study-year={project.etude_annee}
										data-project-year={projectYear}
									>
										<CardProject
											title={project.titre}
											subtitle={project.etude_annee}
											description={project.resume}
											stats={calculateProjectStats(
												project,
											)}
											id={generateProjectId(project)}
											date={formatProjectDate(
												project.projet_annee,
											)}
											imageUrl={getProjectImageUrl(
												project,
											)}
											categories={
												project.categories || []
											}
										/>
									</a>
								);
							})}
						</div>
					) : (
						<ProjectStatus
							type="empty"
							message="Aucun projet n'a été trouvé dans la base de données. Ajoutez des projets via l'interface d'administration PocketBase."
						/>
					)
				}
			</div>
		</section>

		<section
			class="projects-cta-section min-h-[90vh] flex items-center justify-center py-16 px-8 border-t"
		>
			<div class="text-center max-w-2xl">
				<h2
					class="cta-title font-[family-name:var(--font-title2)] font-bold mb-6 tracking-[0.15em] text-center section-neon"
					style="color: var(--color-darkpurple); font-size: var(--size-h2);"
				>
					TRAVAILLONS ENSEMBLE
				</h2>

				<p
					class="cta-description font-[family-name:var(--font-text)] --size-text text-white/70 leading-relaxed mb-8"
				>
					Vous avez un projet en tête ? Contactez-moi pour discuter de
					vos besoins créatifs.
				</p>

				<a
					href="/contact"
					class="cta-button group relative px-8 py-4 bg-gradient-to-r from-[--color-darkpurple] to-[--color-purple] border border-[--color-purple] rounded-lg font-[family-name:var(--font-text)] text-white font-bold tracking-wider overflow-hidden transition-all duration-300 hover:scale-105 hover:border-[--color-pink] inline-flex items-center gap-3"
				>
					<div
						class="absolute inset-0 bg-gradient-to-r from-[--color-pink]/20 to-[--color-purple]/20 opacity-0 group-hover:opacity-100 transition-opacity"
					>
					</div>

					<div class="relative z-10 flex items-center gap-3">
						<svg
							class="w-5 h-5"
							fill="currentColor"
							viewBox="0 0 20 20"
						>
							<path
								d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
							></path>
							<path
								d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"
							></path>
						</svg>
						<span>ME CONTACTER</span>
					</div>

					<div
						class="absolute top-0 -left-full w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent group-hover:left-full transition-all duration-1000"
					>
					</div>
				</a>
			</div>
		</section>
	</main>
		<style>
		.projects-hero-title {
			opacity: 0;
			transform: translateY(30px);
			animation: titleSlideIn 0.2s ease-out 0.1s forwards;
			text-shadow:
				0 0 10px var(--color-darkpurple),
				0 0 20px var(--color-darkpurple),
				0 0 20px var(--color-darkpurple);
			transition: all 0.3s ease;
		}

		@keyframes titleSlideIn {
			0% {
				opacity: 0;
				transform: translateY(30px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.projects-hero-line-wrapper {
			animation: heroLineReveal 0.6s ease-out 0.5s forwards;
		}

		@keyframes heroLineReveal {
			from {
				opacity: 0;
			}
			to {
				opacity: 1;
			}
		}

		.projects-hero-line {
			animation: heroLineExpand 0.8s ease-out 0.6s backwards;
			background: linear-gradient(
				90deg,
				transparent,
				var(--color-purple),
				transparent
			) !important;
		}

		@keyframes heroLineExpand {
			from {
				width: 0;
			}
			to {
				width: 8rem;
			}
		}

		.projects-hero-description {
			animation: descriptionFadeIn 0.6s ease-out 0.9s forwards;
		}

		@keyframes descriptionFadeIn {
			0% {
				opacity: 0;
				transform: translateY(20px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.projects-stats {
			animation: statsFadeIn 0.6s ease-out 1.2s forwards;
		}

		@keyframes statsFadeIn {
			0% {
				opacity: 0;
				transform: translateY(30px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.stat-item {
			transition: all 0.3s ease;
		}

		.stat-item:hover {
			transform: translateY(-5px);
		}

		.stat-item:hover .stat-number {
			text-shadow: 0 0 15px rgba(184, 187, 240, 0.9);
		}

		.section-neon {
			text-shadow:
				0 0 10px var(--color-darkpurple),
				0 0 20px var(--color-darkpurple),
				0 0 20px var(--color-darkpurple);
			animation: neonBreath 4s ease-in-out infinite;
			transition: all 0.3s ease;
		}

		@keyframes neonBreath {
			0%,
			100% {
				text-shadow:
					0 0 10px var(--color-darkpurple),
					0 0 20px var(--color-darkpurple),
					0 0 30px var(--color-darkpurple);
			}
			50% {
				text-shadow:
					0 0 15px var(--color-darkpurple),
					0 0 25px var(--color-darkpurple),
					0 0 35px var(--color-darkpurple),
					0 0 40px var(--color-purple);
			}
		}

		.projects-grid {
			animation: gridFadeIn 0.7s ease-out 1.6s forwards;
			opacity: 0;
		}

		@keyframes gridFadeIn {
			0% {
				opacity: 0;
				transform: translateY(50px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.project-card-link {
			text-decoration: none;
			color: inherit;
			display: inline-block;
		}

		.project-card-link:hover {
		}

		.projects-cta-section {
			opacity: 0;
			transform: translateY(50px);
			transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
		}

		.projects-cta-section.cta-revealed {
			opacity: 1;
			transform: translateY(0);
			animation: ctaSectionReveal 1s ease-out forwards;
		}

		@keyframes ctaSectionReveal {
			0% {
				opacity: 0;
				transform: translateY(50px) scale(0.95);
			}
			50% {
				opacity: 0.7;
				transform: translateY(-10px) scale(1.02);
			}
			100% {
				opacity: 1;
				transform: translateY(0) scale(1);
			}
		}

		.cta-button {
			box-shadow:
				0 0 20px rgba(184, 187, 240, 0.3),
				inset 0 0 10px rgba(184, 187, 240, 0.1);
			animation: buttonPulse 2s ease-in-out infinite;
		}

		@keyframes buttonPulse {
			0%,
			100% {
				box-shadow:
					0 0 20px rgba(184, 187, 240, 0.3),
					inset 0 0 10px rgba(184, 187, 240, 0.1);
			}
			50% {
				box-shadow:
					0 0 30px rgba(184, 187, 240, 0.5),
					inset 0 0 15px rgba(184, 187, 240, 0.2);
			}
		}

		.project-card-link.hidden-by-filter {
			display: none;
		}

		.project-card-link {
			transition: all 0.3s ease;
		}

		@media (max-width: 768px) {
			.projects-hero-title {
				font-size: 2.5rem;
			}

			.projects-stats {
				flex-direction: column;
				gap: 1rem;
			}

			.projects-grid {
				gap: 1rem;
			}

			.filters-grid {
				grid-template-columns: 1fr;
			}
		}
	</style>

	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const ctaSection = document.querySelector(".projects-cta-section");
			let ctaAnimated = false;

			const observerOptions = {
				threshold: 0.3,
				rootMargin: "0px 0px -50px 0px",
			};

			const observer = new IntersectionObserver((entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						if (
							entry.target.classList.contains(
								"projects-cta-section",
							) &&
							!ctaAnimated
						) {
							entry.target.classList.add("cta-revealed");
							ctaAnimated = true;
						}
					}
				});
			}, observerOptions);

			if (ctaSection) {
				observer.observe(ctaSection);
			}
		});
	</script></Layout
>
