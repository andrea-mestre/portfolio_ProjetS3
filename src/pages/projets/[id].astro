---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import HudHeader from "../../components/HudHeader.astro";
import {
  getProjects,
  getProjectImageUrl,
  type Project,
  POCKETBASE_URL,
} from "../../lib/pocketbase";

const figmaIcon = "/icons/figma.svg";
const illustratorIcon = "/icons/illustrator.svg";
const photoshopIcon = "/icons/photoshop.svg";
const krittaIcon = "/icons/krita.svg";
const miroIcon = "/icons/miro.svg";
const notionIcon = "/icons/notion.svg";

const { id } = Astro.params;

let projects: Project[] = [];
let project: Project | null = null;

try {
  projects = await getProjects();
  console.log("Projets récupérés:", projects.length);

  project =
    projects.find((p) => {
      const slug = p.titre
        .toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9-]/g, "");
      return slug === id;
    }) || null;

  console.log("Projet trouvé:", project?.titre || "Aucun");
} catch (error) {
  console.error("Erreur lors de la récupération du projet:", error);
}

if (!project) {
  return Astro.redirect("/projets");
}

function formatProjectDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString("fr-FR", {
    year: "numeric",
    month: "long",
  });
}

function getToolIcon(toolName: string): { src: string; alt: string } {
  const tool = toolName.toLowerCase();

  if (tool.includes("figma")) {
    return { src: figmaIcon, alt: "Figma" };
  }
  if (tool.includes("illustrator") || tool.includes("ai")) {
    return { src: illustratorIcon, alt: "Illustrator" };
  }
  if (tool.includes("photoshop") || tool.includes("ps")) {
    return { src: photoshopIcon, alt: "Photoshop" };
  }
  if (tool.includes("krita")) {
    return { src: krittaIcon, alt: "Krita" };
  }
  if (tool.includes("miro")) {
    return { src: miroIcon, alt: "Miro" };
  }
  if (tool.includes("notion")) {
    return { src: notionIcon, alt: "Notion" };
  }

  return { src: "", alt: toolName };
}
---

<Layout title={`${project.titre} - Andrea Mestre`}>
  <HudHeader currentPage="projets" />

  <main class="relative z-10 pt-24 min-h-screen">
    <div class="flex justify-center mb-8 px-8">
      <h1
        class="text-white tracking-wide text-center drop-shadow-[0_0_10px_rgba(255,255,255,0.5)] max-w-6xl"
        style="font-family: var(--font-title1); font-size: clamp(1.5rem, 4vw, var(--size-title1)); word-wrap: break-word;"
      >
        MISSION : {project.titre}
      </h1>
    </div>

    <div class="flex justify-center mb-8 px-8">
      <div
        class="w-full max-w-6xl py-5 px-16"
        style="background-color: #200A27;"
      >
        <div
          class="flex flex-col md:flex-row justify-between items-center gap-70 text-center"
        >
          <div class="flex-1 text-center">
            <span
              class="text-white --size-smalltext tracking-wider font-[family-name:var(--font-smalltext)]"
            >
              {project.etude_annee}
            </span>
          </div>

          <div class="flex-1 text-center">
            <span
              class="text-white text-sm tracking-wider font-[family-name:var(--font-smalltext)] uppercase"
            >
              {formatProjectDate(project.projet_annee)}
            </span>
          </div>

          <div class="flex-1 text-center">
            <span
              class="text-white text-sm tracking-wider font-[family-name:var(--font-smalltext)] uppercase"
            >
              {project.categories && project.categories.length > 0 ? project.categories[0] : ''}
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="flex justify-center mb-8 px-8">
      <div
        class="w-full max-w-6xl p-8 backdrop-blur-sm relative overflow-hidden"
      >
        <h2
          class="relative font-[family-name:var(--font-title2)] font-bold tracking-[0.15em] section-neon mb-6 text-center"
          style="color: var(--color-darkpurple); font-size: var(--size-h2);"
        >
          RÉSUMÉ
        </h2>

        <p
          class="relative text-white --size-text leading-relaxed font-[family-name:var(--font-text)] text-center"
        >
          {project.resume}
        </p>
      </div>
    </div>

    <section class="project-hero flex justify-center py-8 px-8">
      <div class="w-full max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-55 mb-40">
          <div class="space-y-8 lg:col-span-2">
            <div
              class="project-description">
              <h2
                class="font-[family-name:var(--font-title2)] font-bold tracking-[0.15em] section-neon mb-6"
                style="color: var(--color-darkpurple); font-size: var(--size-title2);"
              >
                LE PROJET
              </h2>

              <div
                class="text-white leading-relaxed font-[family-name:var(--font-text)] space-y-4"
                style="font-size: var(--size-text);"
              >
                {
                  project.description
                    .replace(/<\/?p>/g, "")
                    .split("\n")
                    .map(
                      (paragraph: string) =>
                        paragraph.trim() && <div>{paragraph}</div>,
                    )
                }
              </div>
            </div>

            <div class="grid grid-cols-1 gap-2">
              <div
                class="project-info-block p-6 backdrop-blur-sm"
              >
                <div class="flex gap-10">
                  {
                    project.outils.map((outil: string) => {
                      const icon = getToolIcon(outil);
                      return icon.src ? (
                        <img
                          src={icon.src}
                          alt={icon.alt}
                          title={outil}
                          class="w-15 h-15 object-contain"
                        />
                      ) : null;
                    })
                  }
                </div>
              </div>
              
              {project.titre.toLowerCase().includes('mmi art') && (
                <div class="project-info-block p-6 backdrop-blur-sm mt-4">
                  <a
                    href="https://expo.mmimontbeliard.com/"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="group relative w-full px-6 py-3 bg-gradient-to-r from-[--color-purple] to-[--color-pink] border border-[--color-purple] rounded-lg font-[family-name:var(--font-text)] text-white font-bold tracking-wider overflow-hidden transition-all duration-300 hover:scale-105 hover:border-[--color-pink] inline-flex items-center justify-center gap-3"
                  >
                    <span>VOIR LE SITE WEB</span>
                    <svg
                      class="w-4 h-4 group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                      />
                    </svg>
                    <!-- Effet de scan -->
                    <div
                      class="absolute top-0 -left-full w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent group-hover:left-full transition-all duration-1000"
                    >
                    </div>
                  </a>
                </div>
              )}
            </div>
          </div>

          <div class="flex items-start">
            {
              getProjectImageUrl(project) && (
                <div class="project-image-main w-100 py-50 overflow-hidden" style="animation: float 6s ease-in-out infinite;">
                  <img
                    src={getProjectImageUrl(project)}
                    alt={project.titre}
                    class="w-full h-auto object-contain"
                  />
                </div>
              )
            }
          </div>
        </div>


      </div>
    </section>

    {(project.images?.length > 0 || project.image_resultat?.length > 0) && (
      <section class="project-gallery mb-16 px-4 md:px-8">
        <div class="max-w-7xl mx-auto">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-4">
            {project.images?.map((image: string, index: number) => {
              const imageUrl = `${POCKETBASE_URL}/api/files/projet/${project.id}/${image}`;
              return (
                <div class="gallery-image-item relative overflow-hidden">
                  <img 
                    src={imageUrl}
                    alt={`Process - étape ${index + 1}`}
                    class="gallery-image"
                  />
                </div>
              );
            })}
            
            {project.image_resultat?.map((image: string, index: number) => {
              const imageUrl = `${POCKETBASE_URL}/api/files/projet/${project.id}/${image}`;
              return (
                <div class="gallery-image-item relative overflow-hidden md:col-span-2">
                  <img 
                    src={imageUrl}
                    alt={`Résultat final - ${index + 1}`}
                    class="gallery-image"
                  />
                </div>
              );
            })}
          </div>
        </div>
      </section>
    )}

    <section class="flex justify-center px-8">

        <!-- Section navigation -->
        <div
          class="project-navigation flex flex-col sm:flex-row justify-between items-center gap-4 pt-4 border-t border-white/20"
        >
          <a
            href="/projets"
            class="group relative px-6 py-3 bg-gradient-to-r from-[--color-darkpurple] to-[--color-purple] border border-[--color-purple] rounded-lg font-[family-name:var(--font-text)] text-white font-bold tracking-wider overflow-hidden transition-all duration-300 hover:scale-105 hover:border-[--color-pink] inline-flex items-center gap-3"
          >
            <svg
              class="w-4 h-4 group-hover:-rotate-12 transition-transform"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                clip-rule="evenodd"></path>
            </svg>
            <span>RETOUR AUX PROJETS</span>

            <!-- Effet de scan -->
            <div
              class="absolute top-0 -left-full w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent group-hover:left-full transition-all duration-1000"
            >
            </div>
          </a>

          <div class="text-center">
            <p
              class="text-white/60 text-sm font-[family-name:var(--font-text)]"
            >
              Projet réalisé en <span class="text-[--color-purple] font-bold"
                >{project.etude_annee}</span
              >
            </p>
          </div>

          <!-- Bouton projet suivant -->
          {
            (() => {
              // Générer le slug du projet suivant
              const currentIndex = projects.findIndex((p) => {
                const slug = p.titre
                  .toLowerCase()
                  .replace(/\s+/g, "-")
                  .replace(/[^a-z0-9-]/g, "");
                return slug === id;
              });
              let nextIndex = currentIndex + 1;
              if (nextIndex >= projects.length) nextIndex = 0;
              const nextProject = projects[nextIndex];
              const nextSlug = nextProject.titre
                .toLowerCase()
                .replace(/\s+/g, "-")
                .replace(/[^a-z0-9-]/g, "");
              return (
                <a
                  href={`/projets/${nextSlug}`}
                  class="group relative px-6 py-3 bg-gradient-to-r from-[--color-purple] to-[--color-darkpurple] border border-[--color-purple] rounded-lg font-[family-name:var(--font-text)] text-white font-bold tracking-wider overflow-hidden transition-all duration-300 hover:scale-105 hover:border-[--color-pink] inline-flex items-center gap-3"
                  style="margin-left: auto;"
                >
                  <span>PROJET SUIVANT</span>
                  <svg
                    class="w-4 h-4 group-hover:rotate-12 transition-transform"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                      clip-rule="evenodd"></path>
                  </svg>
                  <!-- Effet de scan -->
                  <div
                    class="absolute top-0 -left-full w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent group-hover:left-full transition-all duration-1000"
                  >
                  </div>
                </a>
              );
            })()
          }
        </div>
      </div>
    </section>
  </main>
</Layout>

<style>
  /* Animations pour la page projet */
  .section-neon {
    text-shadow:
      0 0 10px var(--color-darkpurple),
      0 0 20px var(--color-darkpurple),
      0 0 20px var(--color-darkpurple);
    animation: neonBreath 4s ease-in-out infinite;
    transition: all 0.3s ease;
  }

  @keyframes neonBreath {
    0%,
    100% {
      text-shadow:
        0 0 10px var(--color-darkpurple),
        0 0 20px var(--color-darkpurple),
        0 0 30px var(--color-darkpurple);
    }
    50% {
      text-shadow:
        0 0 15px var(--color-darkpurple),
        0 0 25px var(--color-darkpurple),
        0 0 35px var(--color-darkpurple),
        0 0 40px var(--color-purple);
    }
  }

  .project-info-block {
    animation: fadeInUp 0.8s ease-out forwards;
    opacity: 0;
    transform: translateY(30px);
  }

  .project-info-block:nth-child(1) {
    animation-delay: 0.2s;
  }
  .project-info-block:nth-child(2) {
    animation-delay: 0.4s;
  }
  .project-info-block:nth-child(3) {
    animation-delay: 0.6s;
  }

  .project-description {
    animation: fadeInUp 0.8s ease-out 0.8s forwards;
    opacity: 0;
    transform: translateY(30px);
  }

  .project-image-main {
    animation: fadeInUp 0.8s ease-out 0.6s forwards;
    opacity: 0;
    transform: translateY(30px);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .hierarchy-step {
    transition: all 0.3s ease;
  }

  .hierarchy-step:hover {
    transform: translateY(-5px);
  }

  @keyframes float {
    0%,
    100% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-15px);
    }
  }

  /* Gallery Grid styles */
  .gallery-image-item {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    animation: fadeInScale 0.6s ease-out forwards;
    opacity: 0;
  }

  /* Hauteur fixe pour les 2 premières images */
  .gallery-image-item:nth-child(1),
  .gallery-image-item:nth-child(2) {
    height: 500px;
  }

  .gallery-image-item:nth-child(1) {
    animation-delay: 0.1s;
  }

  .gallery-image-item:nth-child(2) {
    animation-delay: 0.2s;
  }

  .gallery-image-item:nth-child(3) {
    animation-delay: 0.3s;
  }

  .gallery-image-item:nth-child(4) {
    animation-delay: 0.4s;
  }

  .gallery-image-item:nth-child(5) {
    animation-delay: 0.5s;
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .gallery-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Image pleine largeur garde height: auto */
  .gallery-image-item:nth-child(n+3) .gallery-image {
    height: auto;
    object-fit: contain;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .project-info-block {
      margin-bottom: 1rem;
    }

    .gallery-image-item {
      padding: 0;
    }
  }
</style>

<script>
  // Animation d'apparition au scroll
  document.addEventListener("DOMContentLoaded", () => {
    const elements = document.querySelectorAll(
      ".project-info-block, .project-description, .project-image-main, .gallery-image-item",
    );

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.style.opacity = "1";
            entry.target.style.transform = "translateY(0) scale(1)";
          }
        });
      },
      { threshold: 0.1 },
    );

    elements.forEach((el) => observer.observe(el));
  });
</script>
